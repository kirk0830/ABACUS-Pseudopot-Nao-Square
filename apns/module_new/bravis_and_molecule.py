# CITATION
# Bosoni E, Beal L, Bercx M, et al. 
# How to verify the precision of density-functional-theory implementations via 
# reproducible and universal workflows[J]. 
# Nature Reviews Physics, 2024, 6(1): 45-58.
ACWF_REFVOLUME = """
            Ac-X/BCC       45.9436890652
        Ac-X/Diamond      129.7619376361
            Ac-X/FCC       45.5506539230
             Ac-X/SC       49.8290621407
            Ag-X/BCC       17.9815994341
        Ag-X/Diamond       60.1384477535
            Ag-X/FCC       17.8385603821
             Ag-X/SC       20.8078166537
            Al-X/BCC       16.9256568722
        Al-X/Diamond       55.2581279179
            Al-X/FCC       16.4953590598
             Al-X/SC       20.1551394162
            Am-X/BCC       16.1910646994
        Am-X/Diamond       38.9260608838
            Am-X/FCC       17.3637417757
             Am-X/SC       16.1166162914
            Ar-X/BCC       53.3545313857
        Ar-X/Diamond      197.2037257853
            Ar-X/FCC       52.2763833345
             Ar-X/SC       65.2406881909
            As-X/BCC       19.0521510903
        As-X/Diamond       57.0334563896
            As-X/FCC       19.3175775190
             As-X/SC       20.3677497329
            At-X/BCC       40.0072565617
        At-X/Diamond      133.8244131673
            At-X/FCC       39.0306665408
             At-X/SC       46.1440668021
            Au-X/BCC       18.0420836978
        Au-X/Diamond       58.5415097463
            Au-X/FCC       17.9789494007
             Au-X/SC       20.7696027903
             B-X/BCC        6.1393552113
         B-X/Diamond       16.6263169088
             B-X/FCC        5.8915500544
              B-X/SC        6.7004880836
            Ba-X/BCC       63.3054105555
        Ba-X/Diamond      113.1699823796
            Ba-X/FCC       64.1140410061
             Ba-X/SC       61.6056180281
            Be-X/BCC        7.8157560018
        Be-X/Diamond       29.3739872910
            Be-X/FCC        7.8716206739
             Be-X/SC       10.2672356016
            Bi-X/BCC       31.6346675774
        Bi-X/Diamond       96.9022394411
            Bi-X/FCC       31.8104681271
             Bi-X/SC       35.2050582284
            Br-X/BCC       26.7842124781
        Br-X/Diamond       86.1711243924
            Br-X/FCC       26.4175363357
             Br-X/SC       29.8278511781
             C-X/BCC        6.6857220257
         C-X/Diamond       11.3915229468
             C-X/FCC        7.3216347712
              C-X/SC        5.5822112996
            Ca-X/BCC       42.1504734668
        Ca-X/Diamond      159.9693954411
            Ca-X/FCC       42.1942968575
             Ca-X/SC       43.5849131941
            Cd-X/BCC       23.4195726366
        Cd-X/Diamond       74.9080478398
            Cd-X/FCC       22.8412781751
             Cd-X/SC       26.9236002457
            Ce-X/BCC       27.3239643916
        Ce-X/Diamond       60.3696280203
            Ce-X/FCC       26.5223557737
             Ce-X/SC       24.9210139881
            Cl-X/BCC       21.4547444716
        Cl-X/Diamond       67.5148577560
            Cl-X/FCC       21.2881895239
             Cl-X/SC       23.4640292893
            Cm-X/BCC       16.5207822537
        Cm-X/Diamond       38.6523626094
            Cm-X/FCC       17.4924664960
             Cm-X/SC       16.3990024768
            Co-X/BCC       10.5447926821
        Co-X/Diamond       29.7694335456
            Co-X/FCC       10.3083927827
             Co-X/SC       11.8932667993
            Cr-X/BCC       11.5481993396
        Cr-X/Diamond       33.0709117517
            Cr-X/FCC       11.8859164649
             Cr-X/SC       12.8069580127
            Cs-X/BCC      116.8417228518
        Cs-X/Diamond      377.5119512083
            Cs-X/FCC      117.3605789432
             Cs-X/SC      128.3590552257
            Cu-X/BCC       12.0045162940
        Cu-X/Diamond       38.3543187692
            Cu-X/FCC       11.9522246523
             Cu-X/SC       13.9349731242
            Dy-X/BCC       32.2885692044
        Dy-X/Diamond       46.0203764469
            Dy-X/FCC       32.4766359634
             Dy-X/SC       31.8571930831
            Er-X/BCC       33.9307067591
        Er-X/Diamond      160.7182113742
            Er-X/FCC       34.8228848521
             Er-X/SC       35.9430359073
            Eu-X/BCC       26.1340832200
        Eu-X/Diamond       41.3650702486
            Eu-X/FCC       24.9919769933
             Eu-X/SC       17.7951482963
             F-X/BCC       10.0841273303
         F-X/Diamond       29.0048013514
             F-X/FCC       10.1469872576
              F-X/SC       10.5209419861
            Fe-X/BCC       10.5004841964
        Fe-X/Diamond       28.9244448081
            Fe-X/FCC       10.2602117762
             Fe-X/SC       11.6513477719
            Fr-X/BCC      116.4923124868
        Fr-X/Diamond      384.0321596406
            Fr-X/FCC      117.1629536099
             Fr-X/SC      132.1740858506
            Ga-X/BCC       19.2055876101
        Ga-X/Diamond       50.8380451983
            Ga-X/FCC       18.9465000846
             Ga-X/SC       20.1173121537
            Gd-X/BCC       28.9474037903
        Gd-X/Diamond       41.8942701551
            Gd-X/FCC       27.9938704976
             Gd-X/SC       20.8095989335
            Ge-X/BCC       19.2694953095
        Ge-X/Diamond       47.8265898364
            Ge-X/FCC       19.5824508015
             Ge-X/SC       19.9417483114
             H-X/BCC        2.9667742929
         H-X/Diamond        6.8311116562
             H-X/FCC        2.9648091126
              H-X/SC        3.0866686939
            He-X/BCC       18.0303880567
        He-X/Diamond       64.2148789366
            He-X/FCC       17.7725807210
             He-X/SC       21.4852711323
            Hf-X/BCC       22.3047194703
        Hf-X/Diamond       70.1577406488
            Hf-X/FCC       22.5676034192
             Hf-X/SC       24.7811393086
            Hg-X/BCC       29.2371602125
        Hg-X/Diamond      112.5823446507
            Hg-X/FCC       32.3477976932
             Hg-X/SC       29.8543233498
            Ho-X/BCC       33.2672852865
        Ho-X/Diamond       50.8501121827
            Ho-X/FCC       33.8917393870
             Ho-X/SC       34.2940697226
             I-X/BCC       35.9867670342
         I-X/Diamond      121.1452775012
             I-X/FCC       35.1048845030
              I-X/SC       41.5631544369
            In-X/BCC       27.7805802898
        In-X/Diamond       76.4320586824
            In-X/FCC       27.5100988618
             In-X/SC       29.5502109822
            Ir-X/BCC       15.0556415096
        Ir-X/Diamond       43.1935547990
            Ir-X/FCC       14.5049941291
             Ir-X/SC       16.9945041257
             K-X/BCC       73.7795179893
         K-X/Diamond      223.8044852857
             K-X/FCC       74.0044361285
              K-X/SC       79.3544129228
            Kr-X/BCC       67.4634311123
        Kr-X/Diamond      249.7079835831
            Kr-X/FCC       66.0417653419
             Kr-X/SC       82.6645424965
            La-X/BCC       37.8175702599
        La-X/Diamond       74.6380534648
            La-X/FCC       36.9468915219
             La-X/SC       36.7450629470
            Li-X/BCC       20.2674652133
        Li-X/Diamond       51.3867180352
            Li-X/FCC       20.2244785929
             Li-X/SC       20.4088019741
            Lu-X/BCC       29.6257064032
        Lu-X/Diamond      101.2182490481
            Lu-X/FCC       28.9714042450
             Lu-X/SC       32.9400269740
            Mg-X/BCC       22.9172569645
        Mg-X/Diamond       80.8516729950
            Mg-X/FCC       23.1252461440
             Mg-X/SC       27.5805850687
            Mn-X/BCC       10.7808268397
        Mn-X/Diamond       30.3432739437
            Mn-X/FCC       10.7471443132
             Mn-X/SC       11.8988403344
            Mo-X/BCC       15.7925810470
        Mo-X/Diamond       46.0075591929
            Mo-X/FCC       16.0351302591
             Mo-X/SC       17.5962610036
             N-X/BCC        7.2347133844
         N-X/Diamond       18.3533073287
             N-X/FCC        7.6012909873
              N-X/SC        6.4799301718
            Na-X/BCC       37.0150641100
        Na-X/Diamond      109.1430788906
            Na-X/FCC       37.0989860953
             Na-X/SC       39.7513602453
            Nb-X/BCC       18.1415011497
        Nb-X/Diamond       51.5612380786
            Nb-X/FCC       18.7677989613
             Nb-X/SC       20.1149109148
            Nd-X/BCC       21.0678209810
        Nd-X/Diamond       47.0991055430
            Nd-X/FCC       22.7647561474
             Nd-X/SC       18.0765197733
            Ne-X/BCC       24.7112468179
        Ne-X/Diamond       89.1474187039
            Ne-X/FCC       24.3028219458
             Ne-X/SC       29.7451962147
            Ni-X/BCC       10.8950930618
        Ni-X/Diamond       33.0121380345
            Ni-X/FCC       10.8348969207
             Ni-X/SC       12.5590185628
            Np-X/BCC       17.8079227825
        Np-X/Diamond       42.9533016321
            Np-X/FCC       19.2945468597
             Np-X/SC       17.2734160816
             O-X/BCC        7.7862826653
         O-X/Diamond       21.3628964776
             O-X/FCC        7.9987519984
              O-X/SC        7.9535032234
            Os-X/BCC       14.7808432251
        Os-X/Diamond       42.9003271345
            Os-X/FCC       14.3408590455
             Os-X/SC       16.7303790128
             P-X/BCC       14.2301643213
         P-X/Diamond       41.3183089373
             P-X/FCC       14.5635813315
              P-X/SC       14.6564493780
            Pa-X/BCC       24.7971150304
        Pa-X/Diamond       61.0193764146
            Pa-X/FCC       25.2979382957
             Pa-X/SC       24.0207081049
            Pb-X/BCC       31.9704284094
        Pb-X/Diamond       88.0899664601
            Pb-X/FCC       32.0330693820
             Pb-X/SC       34.4758419297
            Pd-X/BCC       15.4442899164
        Pd-X/Diamond       49.0125255975
            Pd-X/FCC       15.3254220778
             Pd-X/SC       17.8613427336
            Pm-X/BCC       20.3578671427
        Pm-X/Diamond       43.3046763305
            Pm-X/FCC       22.2454982473
             Pm-X/SC       17.2982038540
            Po-X/BCC       32.8538744328
        Po-X/Diamond      104.9634814464
            Po-X/FCC       32.5633304447
             Po-X/SC       37.5954709759
            Pr-X/BCC       23.1413663276
        Pr-X/Diamond       52.4401030751
            Pr-X/FCC       24.0941010592
             Pr-X/SC       20.1508127695
            Pt-X/BCC       15.8389750612
        Pt-X/Diamond       48.2299658537
            Pt-X/FCC       15.6559513760
             Pt-X/SC       18.0860881007
            Pu-X/BCC       16.5643372636
        Pu-X/Diamond       40.4075680763
            Pu-X/FCC       17.8021327417
             Pu-X/SC       16.3671826034
            Ra-X/BCC       70.9668672681
        Ra-X/Diamond      339.3371556818
            Ra-X/FCC       71.6269845364
             Ra-X/SC       75.3455997294
            Rb-X/BCC       91.1440710492
        Rb-X/Diamond      282.7553207612
            Rb-X/FCC       91.4274679406
             Rb-X/SC       98.9794397816
            Re-X/BCC       15.1044598171
        Re-X/Diamond       45.1488092366
            Re-X/FCC       15.0163498073
             Re-X/SC       17.1611268525
            Rh-X/BCC       14.4742145663
        Rh-X/Diamond       41.9004577066
            Rh-X/FCC       14.0504550878
             Rh-X/SC       16.3052925485
            Rn-X/BCC       95.4471230782
        Rn-X/Diamond      353.9049285433
            Rn-X/FCC       93.1564256810
             Rn-X/SC      117.6672115419
            Ru-X/BCC       14.2356061964
        Ru-X/Diamond       40.5863643979
            Ru-X/FCC       13.8366151623
             Ru-X/SC       15.8381291955
             S-X/BCC       15.7618462400
         S-X/Diamond       48.5621194269
             S-X/FCC       15.8806885358
              S-X/SC       17.2197235453
            Sb-X/BCC       27.2257889203
        Sb-X/Diamond       85.3650954131
            Sb-X/FCC       27.4896291741
             Sb-X/SC       30.0634121990
            Sc-X/BCC       24.8858518758
        Sc-X/Diamond       68.9151380008
            Sc-X/FCC       24.6868520662
             Sc-X/SC       26.1480548969
            Se-X/BCC       20.3600286206
        Se-X/Diamond       63.5107554328
            Se-X/FCC       20.3778732432
             Se-X/SC       22.6834109000
            Si-X/BCC       14.6451673299
        Si-X/Diamond       40.9149469095
            Si-X/FCC       14.4822031565
             Si-X/SC       16.2292642666
            Sm-X/BCC       21.6458724878
        Sm-X/Diamond       41.8054697730
            Sm-X/FCC       22.8284101769
             Sm-X/SC       17.1965125100
            Sn-X/BCC       27.6472928166
        Sn-X/Diamond       73.6877592925
            Sn-X/FCC       28.0088425653
             Sn-X/SC       29.4530306864
            Sr-X/BCC       54.0128807068
        Sr-X/Diamond      223.7821246728
            Sr-X/FCC       54.8922650546
             Sr-X/SC       57.1290143708
            Ta-X/BCC       18.2919921205
        Ta-X/Diamond       56.8185715387
            Ta-X/FCC       18.8393711237
             Ta-X/SC       20.6669151965
            Tb-X/BCC       30.9008337902
        Tb-X/Diamond       43.3929318627
            Tb-X/FCC       30.5520741878
             Tb-X/SC       27.8199432306
            Tc-X/BCC       14.6195757062
        Tc-X/Diamond       42.4918607430
            Tc-X/FCC       14.5126740985
             Tc-X/SC       16.2350067792
            Te-X/BCC       28.5152914419
        Te-X/Diamond       92.8002629931
            Te-X/FCC       28.2787257642
             Te-X/SC       32.7934878779
            Th-X/BCC       32.5677469591
        Th-X/Diamond       91.4653155955
            Th-X/FCC       32.1839319361
             Th-X/SC       35.3321431170
            Ti-X/BCC       17.2668387055
        Ti-X/Diamond       45.8421534674
            Ti-X/FCC       17.3945872331
             Ti-X/SC       18.4131750886
            Tl-X/BCC       31.4143781862
        Tl-X/Diamond       90.2879174095
            Tl-X/FCC       31.1402049921
             Tl-X/SC       34.3940693000
            Tm-X/BCC       34.3583819751
        Tm-X/Diamond      163.3512533799
            Tm-X/FCC       35.3320901938
             Tm-X/SC       37.2077575159
             U-X/BCC       20.2661778805
         U-X/Diamond       49.5199753572
             U-X/FCC       21.7133355135
              U-X/SC       19.1223788669
             V-X/BCC       13.4607654817
         V-X/Diamond       37.2400616134
             V-X/FCC       13.9049548185
              V-X/SC       14.6801017804
             W-X/BCC       16.1454752416
         W-X/Diamond       49.5504586465
             W-X/FCC       16.4578846361
              W-X/SC       18.3694598023
            Xe-X/BCC       89.0348898020
        Xe-X/Diamond      331.8911738830
            Xe-X/FCC       87.0069651578
             Xe-X/SC      109.8051846381
             Y-X/BCC       33.0304565057
         Y-X/Diamond       87.5187101972
             Y-X/FCC       32.4715444515
              Y-X/SC       34.8169697264
            Yb-X/BCC       34.6395882212
        Yb-X/Diamond      164.1166906281
            Yb-X/FCC       35.7043529273
             Yb-X/SC       38.6416396501
            Zn-X/BCC       15.3751088074
        Zn-X/Diamond       49.3473967449
            Zn-X/FCC       15.1620084721
             Zn-X/SC       18.1790323898
            Zr-X/BCC       22.8447760184
        Zr-X/Diamond       61.9100700077
            Zr-X/FCC       23.2133785116
             Zr-X/SC       24.7431321708
"""

def lookup_acwf_db(bravis: str):
    """bravis will be something like Si_bcc, SiO_X2O3 or something"""
    import re
    assert re.match(r"^([A-Z][a-z]?)_(sc|bcc|fcc|diamond)$", bravis)\
        or re.match(r"^([A-Z][a-z]?[A-Z][a-z]?)_(xy2|xy3|x2y|x2y3|x2y5)$", bravis)\
            , f"bravis required does not match any ACWF token: {bravis}"
    parts = bravis.split("_")
    phase = parts[1].upper() if parts[1].lower() != "diamond" else "Diamond"
    token = f"{parts[0].lower().capitalize()}-X/{phase}"
    refdata = ACWF_REFVOLUME.split("\n")
    for line in refdata:
        if token in line:
            return float(line.split()[1])
    return None

def lookup_bravis_angles(bravis: str):
    
    abc_angles, _, _, _, _ = lookup_bravis_lattice(bravis, 1.0)
    _, _, _, alpha, beta, gamma = abc_angles
    return alpha, beta, gamma

def lookup_bravis_lattice(bravis: str, celldm: float):
    import re
    assert re.match(r"^([A-Z][a-z]?)_(sc|bcc|fcc|diamond)$", bravis)\
        or re.match(r"^([A-Z][a-z]?[A-Z][a-z]?)_(xy2|xy3|x2y|x2y3|x2y5)$", bravis)\
            , f"bravis required does not match any ACWF token: {bravis}"
    kinds, phase = bravis.split("_")
    kinds = [kinds] if phase in ["sc", "bcc", "fcc", "diamond"] else list(re.match(r"([A-Z][a-z]?)([A-Z][a-z]?)", kinds).groups())
    phase = phase.lower()
    func_expr = f"bravis_{phase}(kinds, celldm)"
    return eval(func_expr)

def vol_to_abc_angles(volume: float, angles: list):
    """calculate the characteristic length from the volume of the cell"""
    import numpy as np
    assert len(angles) == 3, f'angles should be a list of 3 floats: {angles}'
    if np.linalg.norm(np.array(angles) - np.array([90, 90, 90])) < 1e-6:
        return volume**(1/3)
    elif np.linalg.norm(np.array(angles) - np.array([60, 60, 60])) < 1e-6:
        return np.sqrt(2)/2 * (4*volume)**(1/3)
    elif np.linalg.norm(np.array(angles) - np.array([109.4712206, 109.4712206, 109.4712206])) < 1e-6:
        return np.sqrt(3)/2 * (2*volume)**(1/3)
    else:
        raise NotImplementedError(f'angles not supported: {angles}')

def bravis_sc(kinds: list, celldm: float):
    """build simple cubic with characteristic length `celldm`
    
    Args:
        bl (float): bond length in Angstrom
    Returns:
        lat (list): lattice parameters, including a, b, c and alpha, beta, gamma
        labels (list): atom labels, each atom has one
        kinds (list): kinds that present cell has
        labels_kinds_map (list): mapping the index of coords to kinds, size = n_atoms
        coords (np.ndarray): coordinates of atoms
    """
    assert len(kinds) == 1
    import numpy as np
    return [celldm, celldm, celldm, 90, 90, 90], kinds, kinds, \
        [0], np.array([[0, 0, 0]])

def bravis_bcc(kinds: list, celldm: float):
    """build body centered cubic with characteristic length `celldm`
    
    Args:
        bl (float): bond length in Angstrom
    Returns:
        lat (list): lattice parameters, including a, b, c and alpha, beta, gamma
        labels (list): atom labels, each atom has one
        kinds (list): kinds that present cell has
        labels_kinds_map (list): mapping the index of coords to kinds, size = n_atoms
        coords (np.ndarray): coordinates of atoms
    """
    assert len(kinds) == 1
    import numpy as np
    return [celldm, celldm, celldm, 109.4712206, 109.4712206, 109.4712206], kinds, kinds, \
        [0], np.array([[0, 0, 0]])

def bravis_fcc(kinds: list, celldm: float):
    """build face centered cubic with characteristic length `celldm`
    
    Args:
        bl (float): bond length in Angstrom
    Returns:
        lat (list): lattice parameters, including a, b, c and alpha, beta, gamma
        labels (list): atom labels, each atom has one
        kinds (list): kinds that present cell has
        labels_kinds_map (list): mapping the index of coords to kinds, size = n_atoms
        coords (np.ndarray): coordinates of atoms
    """
    assert len(kinds) == 1
    import numpy as np
    return [celldm, celldm, celldm, 60.0, 60.0, 60.0], kinds, kinds, \
        [0], np.array([[0, 0, 0]])

def bravis_diamond(kinds: list, celldm: float):
    """build diamond with characteristic length `celldm`
    
    Args:
        bl (float): bond length in Angstrom
    Returns:
        lat (list): lattice parameters, including a, b, c and alpha, beta, gamma
        labels (list): atom labels, each atom has one
        kinds (list): kinds that present cell has
        labels_kinds_map (list): mapping the index of coords to kinds, size = n_atoms
        coords (np.ndarray): coordinates of atoms
    """
    assert len(kinds) == 1
    import numpy as np
    return [celldm, celldm, celldm, 60.0, 60.0, 60.0], kinds * 2, kinds, \
        [0, 0], np.array([[0, 0, 0], [0.25, 0.25, 0.25]])

def bravis_x2y(kinds: list, celldm: float):
    """build X2Y structure with characteristic length `celldm`
    
    Args:
        bl (float): bond length in Angstrom
    Returns:
        lat (list): lattice parameters, including a, b, c and alpha, beta, gamma
        labels (list): atom labels, each atom has one
        kinds (list): kinds that present cell has
        labels_kinds_map (list): mapping the index of coords to kinds, size = n_atoms
        coords (np.ndarray): coordinates of atoms
    """
    assert len(kinds) == 2
    import numpy as np
    return [celldm, celldm, celldm, 60, 60, 60], [kinds[0]]*2 + [kinds[1]], kinds, \
        [0]*2 + [1]*1, \
        np.array([[0.75, 0.75, 0.75], [0.25, 0.25, 0.25], [0, 0, 0]])

def bravis_x2y3(kinds: list, celldm: float):
    """build X2Y3 structure with characteristic length `celldm`
    
    Args:
        bl (float): bond length in Angstrom
    Returns:
        lat (list): lattice parameters, including a, b, c and alpha, beta, gamma
        labels (list): atom labels, each atom has one
        kinds (list): kinds that present cell has
        labels_kinds_map (list): mapping the index of coords to kinds, size = n_atoms
        coords (np.ndarray): coordinates of atoms
    """
    assert len(kinds) == 2
    import numpy as np
    return [celldm, celldm, celldm, 90, 90, 90], [kinds[0]]*4 + [kinds[1]]*6, kinds, \
        [0]*4 + [1]*6, \
        np.array([[0.25, 0.25, 0.25], [0.75, 0.75, 0.25], [0.75, 0.25, 0.75], 
                    [0.25, 0.75, 0.75], 
                    [0.5, 0, 0], [0, 0.5, 0], [0, 0, 0.5], [0.5, 0.5, 0], 
                    [0.5, 0, 0.5], [0, 0.5, 0.5]])

def bravis_x2y5(kinds: list, celldm: float):
    """build X2Y5 structure with characteristic length `celldm`
    
    Args:
        bl (float): bond length in Angstrom
    Returns:
        lat (list): lattice parameters, including a, b, c and alpha, beta, gamma
        labels (list): atom labels, each atom has one
        kinds (list): kinds that present cell has
        labels_kinds_map (list): mapping the index of coords to kinds, size = n_atoms
        coords (np.ndarray): coordinates of atoms
    """
    assert len(kinds) == 2
    import numpy as np
    return [celldm, celldm, celldm, 90, 90, 90], [kinds[0]]*4 + [kinds[1]]*10, kinds, \
        [0]*4 + [1]*10, \
        np.array([[0.75, 0.75, 0.75], [0.25, 0.25, 0.75], [0.25, 0.75, 0.25],
                    [0.75, 0.25, 0.25],
                    [0.25, 0.75, 0.75], [0.75, 0.25, 0.75], [0.75, 0.75, 0.25],
                    [0.25, 0.25, 0.25], [0.5, 0.5, 0], [0.5, 0, 0.5],
                    [0, 0.5, 0.5], [0.5, 0, 0], [0, 0.5, 0],
                    [0, 0, 0.5]])

def bravis_xy(kinds: list, celldm: float):
    """build XO structure with characteristic length `celldm`
    
    Args:
        bl (float): bond length in Angstrom
    Returns:
        lat (list): lattice parameters, including a, b, c and alpha, beta, gamma
        labels (list): atom labels, each atom has one
        kinds (list): kinds that present cell has
        labels_kinds_map (list): mapping the index of coords to kinds, size = n_atoms
        coords (np.ndarray): coordinates of atoms
    """
    assert len(kinds) == 2
    import numpy as np
    return [celldm, celldm, celldm, 60, 60, 60], kinds, kinds, \
        [0]*1 + [1]*1, \
        np.array([[0, 0, 0], [0.5, 0.5, 0.5]])

def bravis_xy2(kinds: list, celldm: float):
    """build XO2 structure with characteristic length `celldm`
    
    Args:
        bl (float): bond length in Angstrom
    Returns:
        lat (list): lattice parameters, including a, b, c and alpha, beta, gamma
        labels (list): atom labels, each atom has one
        kinds (list): kinds that present cell has
        labels_kinds_map (list): mapping the index of coords to kinds, size = n_atoms
        coords (np.ndarray): coordinates of atoms
    """
    assert len(kinds) == 2
    import numpy as np
    return [celldm, celldm, celldm, 60, 60, 60], [kinds[0]]*1 + [kinds[1]]*2, kinds, \
        [0]*1 + [1]*2, \
        np.array([[0, 0, 0], [0.75, 0.75, 0.75], [0.25, 0.25, 0.25]])

def bravis_xy3(kinds: list, celldm: float):
    """build XO3 structure with characteristic length `celldm`
    
    Args:
        bl (float): bond length in Angstrom
    Returns:
        lat (list): lattice parameters, including a, b, c and alpha, beta, gamma
        labels (list): atom labels, each atom has one
        kinds (list): kinds that present cell has
        labels_kinds_map (list): mapping the index of coords to kinds, size = n_atoms
        coords (np.ndarray): coordinates of atoms
    """
    import numpy as np
    return [celldm, celldm, celldm, 60, 60, 60], [kinds[0]]*1 + [kinds[1]]*3, kinds, \
        [0]*1 + [1]*3, \
        np.array([[0, 0, 0], 
                    [0.5, 0, 0], [0, 0.5, 0], [0, 0, 0.5]])

def lookup_molecule(molecule: str, bond_length: float):
    import re
    assert re.match(r"^([A-Z][a-z]?)_(dimer|trimer|tetramer)$", molecule), f"does not match any predefined molecule: {molecule}"
    assert isinstance(bond_length, float), f"must specify a float number as bond length: {bond_length}"
    kind, shape = molecule.split("_")
    shape = shape.lower()
    func_expr = f"molecule_{shape}(kind, bond_length)"
    return eval(func_expr)

def molecule_dimer(kind: str, bl: float):
    """build dimer with bond length `bl`
    
    Args:
        bl (float): bond length in Angstrom
    Returns:
        lat (list): lattice parameters, including a, b, c and alpha, beta, gamma
        labels (list): atom labels, each atom has one
        kinds (list): kinds that present cell has
        labels_kinds_map (list): mapping the index of coords to kinds, size = n_atoms
        coords (np.ndarray): coordinates of atoms
    """
    import numpy as np
    return [20, 20, 20, 90, 90, 90], [kind, kind], [kind], \
        [0, 0], np.array([[0, 0, 0], [bl, 0, 0]])

def molecule_trimer(kind: str, bl: float):
    """build triangle with bond length `bl`
    
    Args:
        bl (float): bond length in Angstrom
    Returns:
        lat (list): lattice parameters, including a, b, c and alpha, beta, gamma
        labels (list): atom labels, each atom has one
        kinds (list): kinds that present cell has
        labels_kinds_map (list): mapping the index of coords to kinds, size = n_atoms
        coords (np.ndarray): coordinates of atoms
    """
    import numpy as np
    return [20, 20, 20, 90, 90, 90], [kind, kind, kind], [kind], \
        [0, 0, 0], np.array([[0, 0, 0], [bl, 0, 0], [bl/2, bl/2*3**0.5, 0]])

def molecule_tetramer(kind: str, bl: float):
    """build tetrahedron with bond length `bl`
    
    Args:
        bl (float): bond length in Angstrom
    Returns:
        lat (list): lattice parameters, including a, b, c and alpha, beta, gamma
        labels (list): atom labels, each atom has one
        kinds (list): kinds that present cell has
        labels_kinds_map (list): mapping the index of coords to kinds, size = n_atoms
        coords (np.ndarray): coordinates of atoms
    """
    import numpy as np
    return [20, 20, 20, 90, 90, 90], [kind, kind, kind, kind], [kind], \
        [0, 0, 0, 0], np.array([[0, 0, 0], [bl, 0, 0], [bl/2, bl/2*3**0.5, 0], [bl/2, bl/2*3**0.5/3, bl/2*3**0.5]])

import unittest
class TestMolecule(unittest.TestCase):
    def test_lookup_molecule(self):
        result = lookup_molecule("Si_dimer", 1.0)
        self.assertEqual(result[0], [20, 20, 20, 90, 90, 90])
        self.assertEqual(result[1], ['Si']*2)
        self.assertEqual(result[2], ['Si'])
        self.assertEqual(result[3], [0]*2)
        self.assertEqual(result[4].tolist(), [[0, 0, 0], [1, 0, 0]])

        result = lookup_molecule("O_trimer", 1.0)
        self.assertEqual(result[0], [20, 20, 20, 90, 90, 90])
        self.assertEqual(result[1], ['O']*3)
        self.assertEqual(result[2], ['O'])
        self.assertEqual(result[3], [0]*3)
        self.assertEqual(result[4].tolist(), [[0.0, 0.0, 0.0], [1.0, 0.0, 0.0], [0.5, 0.8660254037844386, 0.0]])

    def test_lookup_bravis_angles(self):
        result = lookup_bravis_angles("Si_sc")
        self.assertEqual(result, (90, 90, 90))

        result = lookup_bravis_angles("Si_fcc")
        self.assertEqual(result, (60, 60, 60))

        result = lookup_bravis_angles("Si_diamond")
        self.assertEqual(result, (60, 60, 60))

        result = lookup_bravis_angles("SiO_xy2")
        self.assertEqual(result, (60, 60, 60))

        result = lookup_bravis_angles("VO_xy3")
        self.assertEqual(result, (60, 60, 60))

        result = lookup_bravis_angles("VO_x2y5")
        self.assertEqual(result, (90, 90, 90))

    def test_lookup_bravis_lattice(self):
        result = lookup_bravis_lattice("Si_sc", 1.0)
        self.assertEqual(result[0], [1, 1, 1, 90, 90, 90])
        self.assertEqual(result[1], ['Si'])
        self.assertEqual(result[2], ['Si'])
        self.assertEqual(result[3], [0])
        self.assertEqual(result[4].tolist(), [[0, 0, 0]])


if __name__ == "__main__":
    unittest.main()